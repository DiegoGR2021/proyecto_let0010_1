---
title: "informe"
author: "Diego Gallo"
date: "03-12-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/Diego/Desktop/InformeLET/informe_let")
knitr::opts_knit$set(out_dir = "4 - productos/")
```

# Análisis de la Rentabilidad Real de los Fondos de Pensiones 

# Introducción {#intro}

  Uno de los aspectos que me resulta más interesante respecto a los polémicos fondos de pensiones en Chile, es su funcionamiento y cómo se ven afectados por acontecimientos tanto internacionales, como los que ocurren en nuestra propia patria, y para eso, necesitamos saber qué son específicamente, y bajo que reglas y condiciones se rigen.

# Contexto {#cont}

 Las administradoras de fondos de pensiones, o mejor conocidas como A.F.P, son instituciones financieras encargadas de administrar los fondos de cuentas individuales de ahorro para pensiones, entonces corresponden a un patrimonio constituido por todas la cotizaciones obligatorias y voluntarias que efectúan los trabajadores en su cuenta de capitalización individual, más depósitos voluntarios, y aportes adicionales, junto a las rentabilidades de sus respectivas inversiones, restando las comisiones que cobran la administradora. 
 
 Existen 5 alternativas de inversión, denominados fondos de pensiones tipo A, B, C, D y E, estos se diferencian en la proporción de los recursos financieros invertidos en renta variable y renta fija, en donde los primeros representan propiedad de una sociedad o empresa, tales como acciones, por ende tienen mayor riesgo y rentabilidad esperada, los segundos tienen una rentabilidad conocida que varía de acuerdo a su valor de mercado, y tienen menor riesgo y menos rentabilidad esperada.
 
 De los 5 fondos antes mencionados, el fondo A tiene una mayor proporción invertida en renta variable, que disminuye a medida que nos acercamos a los fondos B, C, y D, y finalmente el fondo E, invierte principalmente en renta fija. (ref:aafp)

# Problema

  Ahora conociendo el contexto de las AFP, y su manera de invertir, nos gustaría saber que tipo de fondo renta más en promedio, como se ven afectados por diversos factores, como los movimientos de la bolsa chilena, el valor del dólar, de la uf, tasas de interés de los bancos, ocurrencias nacionales y internacionales, y la especulación.

# Datos {#data}

 Desde la página de la superintendencia de pensiones, podemos encontrar una serie de tablas con las rentabilidades de los distintos tipos de fondos, y tipos de AFP, los cuales podemos seleccionar por mes y año, desde el año 2005 hasta hoy, para motivos de mi informe, desecharé el año 2005 ya que tiene demasiados vacíos. (ref:rent)
 
```{r out.width="90%", fig.alig = "center"}
  knitr::include_graphics("3 - figuras/captura_sp_rent.png")
```

 Para poder comenzar, ya que la página no nos permite descargar ningún documento con los datos y además todas las selecciones cuentan con la misma url, usando "web-scraping", obtendremos los datos de la primera y segunda columna de cada tabla, pues contienen el nombre de la AFP y su rentabilidad obtenida es mes y año respectivos, por ende haciendo uso de Python, y con ayuda de los paquetes (BeautifulSoup, Chromedriver, Selenium, Pandas, Time), por los siguientes motivos:
 
 BeautifulSoup: Facilita la recolección de datos del sitio, y diversos métodos para poder filtrar diversas variables del documento html.
 
 Chromedriver: Es necesario para poder inicializar una sesión de Chrome y usar Selenium.
 
 Selenium: Nos permite ingresar a la url y conseguir sus datos, aparte de automatizar clicks, debido a que no podemos hacer uso de post, ya que hay que clickear en buscar para obtener las tablas respectivas.
 
 Pandas: Lo usaré exclusivamente para guardar los datos como dataframe en un archivo xlsx.
 
 Time: Necesario para evitar que la página de un error al mandar solicitudes demasiado rápido.
 
 Debido a la gran cantidad de iteraciones que debe hacer el documento, no lo incluiré de manera funcional en el informe, acá se encuentra el link para acceder a él en github. <https://github.com/DiegoGR2021/informe-let/blob/367ba5bd9dcde115c0ec41db7389b00e5cf27244/1%20-%20codigo/web_scraperdef.py>
 
 Importamos los paquetes mencionados:
 
```{verbatim}
import chromedriver_autoinstaller
import pandas as pd
import time
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.common.by import By
```
 
 Guardamos la url y definimos algunas variables:
 
```{verbatim}
url = "https://www.spensiones.cl/apps/rentabilidad/getRentabilidad.php?tiprent=FP"
years = ["years", "2021", "2020", "2019", "2018", "2017", "2016", "2015", "2014", "2013", "2012", "2011", "2010", "2009", "2008", "2007", "2006"]
months = ["months", 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
muestras_final = []
```
 
 Iteramos para obtener todas la combinaciones de meses y años entre el 2006, 2021:
 
```{verbatim}
for i in range(1, 17):
    for j in range(1, 13):
        time.sleep(2)
        chromedriver_autoinstaller.install()
        driver = webdriver.Chrome() 
        driver.set_window_size(1024, 768) 
        driver.get(url)
        driver.save_screenshot("screen.png") 
        sbtn = driver.find_element(By.NAME, "btn")
        dropdown1 = driver.find_element(By.NAME, "aaaa")
        dropdown2 = driver.find_element(By.NAME, "mm")
        year = driver.find_element(By.XPATH, "/html/body/div[5]/div/div[2]/div/div[2]/form/table[1]/tbody/tr[2]/td/table/tbody/tr/td/select[1]/option["+str(i)+"]")
        month = driver.find_element(By.XPATH, "/html/body/div[5]/div/div[2]/div/div[2]/form/table[1]/tbody/tr[2]/td/table/tbody/tr/td/select[2]/option["+str(j)+"]")
        dropdown1.click()
        year.click()
        dropdown2.click()
        month.click()
        sbtn.click()
        muestras = []

        source = driver.page_source
        soup = BeautifulSoup(source, "html.parser")
        tablas = soup.find_all("table", class_ = "table table-striped table-hover table-bordered table-condensed")[1:]
        largo = len(tablas[0].find_all("td"))
        largoespec = len(tablas[2].find_all("td"))

        for m in range(0, largo, 5):
                dato = []
                dato.append(tablas[0].find_all("td")[m].get_text())
                print(dato)
                muestras.append(dato)

        # FONDO A
        for a in range(0, largo, 5):
            if tablas[0].find_all("td")[a+1].get_text().count("%") == 0:
                A = 0.0
            else:
                A = float(tablas[0].find_all("td")[a+1].get_text().strip("%").replace(',','.'))
            muestras[int(a/5)].append(A)
    
        # FONDO B
        for b in range(0, largo, 5):
            if tablas[1].find_all("td")[b+1].get_text().count("%") == 0:
                B = 0.0
            else:
                B = float(tablas[1].find_all("td")[b+1].get_text().strip("%").replace(',','.'))
            muestras[int(b/5)].append(B)
    
        # FONDO C CASO ESPECIAL
        for c in range(0, largoespec, 6):
            if tablas[2].find_all("td")[c+1].get_text().count("%") == 0:
                C = 0.0
            else:
                C = float(tablas[2].find_all("td")[c+1].get_text().strip("%").replace(',','.'))
            muestras[int(c/6)].append(C)

        # FONDO D
        for d in range(0, largo, 5):
            if tablas[3].find_all("td")[d+1].get_text().count("%") == 0:
                D = 0.0
            else:
                D = float(tablas[3].find_all("td")[d+1].get_text().strip("%").replace(',','.'))
            muestras[int(d/5)].append(D)

        # FONDO E CASO ESPECIAL
        for e in range(0, largoespec, 6):
            if tablas[4].find_all("td")[e+1].get_text().count("%") == 0:
                E = 0.0
            else:
                E = float(tablas[4].find_all("td")[e+1].get_text().strip("%").replace(',','.'))
            muestras[int(e/6)].append(E)
        
        for muestra in muestras:
            muestra.append(years[i])
            muestra.append(months[j])
            muestras_final.append(muestra)
```
 
 Guardamos los datos como un data frame:
 
```{verbatim}
df = pd.DataFrame(muestras_final)
df.to_excel("30-11-2021_rentabilidad_afps.xlsx", index = False)
```

 Con esto ya disponemos de una base de datos que podemos importar, he sido cuidadoso a la hora de definir los tipos de cada variable, guardar los números en formato float, y variables categóricas como string, también reemplacé las comas por puntos, datos vacíos por 0.0 (float) y eliminé los símbolos %.

# Método

 Importaré los paquetes que usaré para trabajar durante el informe:
 
```{r}
library(tidyverse)
library(rio)
```
 
 Uso rio para importar bases de datos por comodidad, tidyverse no requiere explicación.
 
 Cargamos la base de datos:
```{r}
rentabilidades <- rio::import("2 - datos/30-11-2021_rentabilidad_afps.xlsx")
```

```{r}
head(rentabilidades)
```

 Tenemos que en la primera columna se encuentra el nombre de la AFP, luego la rentabilidad de cada fondo desde el A al E, finalmente el mes y el año.
 
```{r}
length(rentabilidades[, 1])
```
 Contamos con un total de 1342 observaciones.

```{r}
cor(rentabilidades[, 2:6])
```
 Analizamos la correlación entre los valores de los distintos fondos, y podemos ver que los fondos que menos se parecen respecto a rentabilidades, son el A y el E, pues tienen una correlación bajísima, lo cuál es lógico, ya que sus niveles de riesgo y sus objetivos son muy distintos, así, en base a estos dos fondos, haré la mayor parte del análisis ya que son los representan el blanco y el negro en las AFP.
 
 Ahora una mínima modificación que se debería hacer a la base de datos, es crear una variable dummy que nos indique a que mes corresponde cada muestra para analizar los casos anuales, y otra para filtrar las distintas AFP.
 
 También nos interesaría ver como han reaccionado los fondos a los diversos sucesos de los últimos años, como la crisis financiera del 2008, el estallido social en 2019, la pandemia de coronavirus en el 2020, entre otros.

# Conclusión 
 
 
# Referencias

[1] [Fondo de Pensiones](https://afiliadoinformado.cl/wp-content/uploads/2018/06/12_FondodePensiones.pdf) @aafp

[2] [Rentabilidades](https://www.spensiones.cl/apps/rentabilidad/getRentabilidad.php?tiprent=FP&template=0) @rent
 
 