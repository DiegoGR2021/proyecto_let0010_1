---
title: "Análisis de la Rentabilidad Real de los Fondos de Pensiones"
author: "Diego Gallo"
format: html
editor: visual
---

```{r, echo = FALSE, include = FALSE}
library(egg)
library(forecast)
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)
library(rio)
library(tidyverse)
library(MASS)
library(moments)
library(reshape2)

fn = local({
  lll = 0
  function(x) {
    lll <<- lll + 1
    paste('Figura ', lll, ': ', x, sep = '')
  }
})

hist_dens = function(df, col, fignum, xlab = "", main = ""){
  ggplot(data = df, aes(x = {{col}})) +
  geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
  geom_density() +
  labs(x = xlab, y = "Densidad", main = paste("Figura ", fignum, ": ", main, sep = ""))
}

residual_diagnostic = function(mod){

  res = mod$residuals/sd(mod$residuals)

  par(mfrow = c(1, 3))

  hist(res, main = fn("Histograma"), xlab = "Residuales Estandarizados", ylab = "Frecuencia")

  qqnorm(res, main = fn("Gráfico Q-Q Normal"), xlab = "Cantidades Teóricas", ylab = "Cuantiles Muestrales")
  qqline(res, col = "blue") 

  plot(ecdf(res), main = fn("Función de Distribución Empírica"),xlab = "Residuales Estandarizados", ylab = "")
  }

set.seed(22091998)
```

# **Introducción**

Uno de los aspectos que me resulta más interesante respecto a los polémicos fondos de pensiones en Chile, es su funcionamiento y cómo se ven afectados por acontecimientos tanto internacionales, como los que ocurren en nuestra propia patria, y para eso, necesitamos saber qué son específicamente, los fondos que hay, y las AFP que existen.

# **Contexto**

Las administradoras de fondos de pensiones, o mejor conocidas como A.F.P, son instituciones financieras encargadas de administrar los fondos de cuentas individuales de ahorro para pensiones, entonces corresponden a un patrimonio constituido por todas la cotizaciones obligatorias y voluntarias que efectúan los trabajadores en su cuenta de capitalización individual, más depósitos voluntarios, y aportes adicionales, junto a las rentabilidades de sus respectivas inversiones, restando las comisiones que cobran la administradora.

Existen 5 alternativas de inversión, denominados fondos de pensiones tipo A, B, C, D y E, estos se diferencian en la proporción de los recursos financieros invertidos en renta variable y renta fija, en donde los primeros representan propiedad de una sociedad o empresa, tales como acciones, por ende tienen mayor riesgo y rentabilidad esperada, los segundos tienen una rentabilidad conocida que varía de acuerdo a su valor de mercado, y tienen menor riesgo y menos rentabilidad esperada.

De los 5 fondos antes mencionados, el fondo A tiene una mayor proporción invertida en renta variable, que disminuye a medida que nos acercamos a los fondos B, C, y D, y finalmente el fondo E, invierte principalmente en renta fija.

Actualmente las inversiones se rigen por los siguientes máximos y mínimos para instrumentos de renta variable:

Fondo A: Máximo = 80%, Mínimo obligatorio = 40%

Fondo B: Máximo = 60%, Mínimo obligatorio = 25%

Fondo C: Máximo = 40%, Mínimo obligatorio = 15%

Fondo D: Máximo = 20%, Mínimo obligatorio = 5%

Fondo E: Máximo = 5%, Mínimo obligatorio = 0%

# **Objetivos**

Ahora conociendo el contexto de las AFP, y sus rasgos generales de inversión, podemos plantearnos las siguientes preguntas:

¿Cuál de las AFP presenta mejores resultados?.

¿Qué tanto afectó a las AFP la crisis subprime del 2008?.

¿Qué tan mal dejó a las AFP el terremoto del 2010?.

¿Cómo se vieron afectadas las rentabilidades de las AFP por el estallido social ocurrido en octubre de 2019?.

¿Cómo ha afectado la pandemia del 2020 a las rentabilidades de las AFP?, ¿Fue negativo el impacto?.

¿Qué fondos se ven menos afectados por los problemas nacionales?.

¿Qué fondos se ven menos afectados por problemáticas internacionales?.

Entonces además de observar el rendimiento de los distintos fondos y las distintas AFP, vamos a verlo en perspectiva histórica, para observar como se comporta su rentabilidad a lo largo de los años, haciendo énfasis en algunos años clave.

# **Datos**

Desde la página de la superintendencia de pensiones, podemos encontrar una serie de tablas con las rentabilidades de los distintos tipos de fondos, y tipos de AFP, los cuales podemos seleccionar por mes y año, desde el año 2005 hasta hoy, para motivos de mi informe, desecharé el año 2005 ya que tiene demasiados valores faltantes.

Para poder comenzar, ya que la página no nos permite descargar ningún documento con los datos y además todas las selecciones cuentan con la misma url, usando “web-scraping”, obtendremos los datos de la primera y segunda columna de cada tabla, pues contienen el nombre de la AFP y su rentabilidad obtenida es mes y año respectivos, por ende haciendo uso de Python, y con ayuda de los paquetes (BeautifulSoup, Chromedriver, Selenium, Pandas, Time).

Debido a la gran cantidad de iteraciones que debe hacer el documento, no lo incluiré de manera funcional en el informe, el link se puede encontrar en el anexo.

Así ya disponemos de una base de datos que podemos importar, he sido cuidadoso a la hora de definir los tipos de cada variable, guardar los números en formato float, y variables categóricas como string, también reemplacé las comas por puntos, datos vacíos por 0.0 (float) y eliminé los símbolos %, por lo que no será necesario limpiar los datos.

A la hora de hacer el análisis, se filtrarán los datos según se requiera, y se eliminaran AFPs con pocas observaciones
y se usarán fondos representativos de ser necesarios.

# **Análisis Exploratorio**

```{r, include = FALSE}
datos = rio::import("C:/Users/Diego/Desktop/proyecto_let0010_1/datos/30-11-2021_rentabilidad_afps.xlsx")
cor(datos[, 2:6])
```
Analizamos la correlación entre los valores de los distintos fondos, y podemos ver que los fondos que menos se parecen respecto a rentabilidades, son el A y el E, pues tienen una correlación bajísima, lo cuál es lógico, ya que sus niveles de riesgo y sus objetivos son muy distintos, así, en base a estos dos fondos, haré la mayor parte del análisis ya que son los que representan el blanco y el negro en las AFP.

Ahora estamos en condiciones de zambullirnos y solucionar nuestras anécdotas:

De los dos fondos anteriormente mencionados, al tener niveles de riesgo muy distintos, el fondo A debería reportar muchas mas ganancias que el fondo E, el cual es más conservador, entonces los comparamos usando una AFP cualquiera:



```{r}
colMeans(datos[, 2:6])
```

```{r, include = FALSE}
datos = rio::import("C:/Users/Diego/Desktop/proyecto_let0010_1/datos/30-11-2021_rentabilidad_afps.xlsx")
retornos_capital_a = datos[datos$A.F.P. == "CAPITAL", ]
retornos_capital_a = retornos_capital_a[c("A", "Año", "Mes")]
retornos_capital_a$Mes = plyr::revalue(retornos_capital_a$Mes, c("Enero" = 1, "Febrero" = 2, "Marzo" = 3, "Abril" = 4, "Mayo" = 5, "Junio" = 6, "Julio" = 7, "Agosto" = 8, "Septiembre" = 9, "Octubre" = 10, "Noviembre" = 11, "Diciembre" = 12))
retornos_capital_a$Mes = as.numeric(retornos_capital_a$Mes)
retornos_capital_a$Año = as.numeric(retornos_capital_a$Año)

retornos_capital_a$t = retornos_capital_a$Año + (retornos_capital_a$Mes - 1)/12
new_ret = retornos_capital_a[c("t", "A")]

new_rets = arrange(new_ret, t)
```

Descripción inicial de las variables en el archivo rentabilidad_afps:

| Variable | Tipo            | Descripción          |
|----------|-----------------|----------------------|
| A.F.P.   | Cadena de texto | Nombre de la AFP     |
| A        | Punto flotante  | Rentabilidad Fondo A |
| B        | Punto flotante  | Rentabilidad Fondo B |
| C        | Punto flotante  | Rentabilidad Fondo c |
| D        | Punto flotante  | Rentabilidad Fondo D |
| E        | Punto flotante  | Rentabilidad Fondo E |
| Año      | Entero          | Año respectivo       |
| Mes      | Cadena de texto | Mes respectivo       |

Para la primera revisión de los datos, usaremos particularmente las rentabilidades del Fondo A de AFP Capital, inicialmente nos interesa saber como se comportan sus momentos, y como ha progresado la rentabilidad a lo largo del tiempo, también queremos observar si la serie tiene rasgos estacionarios, y ver si estos se podrían extrapolar a las demás AFPS y fondos.

```{r}
ggplot(retornos_capital_a, aes(x = t, y = A)) +
  geom_line(color = "blue") +
  ggtitle(fn("Retornos mensuales de AFP Capital Fondo A, período 2008-2021")) + xlab("Año") + ylab("Retornos")
```

Como podemos observar en la Figura 1, las rentabilidades presentan una alta volatilidad, y parecieran tener una media bastante cercana a 0, también son notorias las caídas en los períodos 2008-2009 y 2020, que calzan con la crisis económica del 2008 y la pandemia COVID.

```{r}
ggAcf(new_rets$A, lag.max = 20) +
  ggtitle(fn("Autocorrelación de los retornos del Fondo A Capital"))
```

```{r}
ggPacf(new_rets$A ,lag.max = 20) +
  ggtitle(fn("Autocorrelación parcial de los retornos del Fondo A Capital"))
```

```{r}
ggplot(retornos_capital_a, aes(x = log(A^2))) +
  geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
  geom_density()
```

```{r}
rets2 = new_rets$A^2
ggAcf(log(rets2))
```

```{r}
datos2 = rio::import("C:/Users/Diego/Desktop/proyecto_let0010_1/datos/30-11-2021_rentabilidad_afps.xlsx")
afps = unique(datos2$A.F.P.)
```

```{r}
paste("AFP", "A", "B", "C", "D", "E")
for (i in 1:length(afps)){
  afp_temp = datos2 %>%
    filter(A.F.P. == afps[i])
  print(paste(afps[i], mean(afp_temp$A), mean(afp_temp$B), mean(afp_temp$C), mean(afp_temp$D), mean(afp_temp$E)))
}
```

```{r}
paste("AFP", "N Obs")
for (i in 1:length(afps)){
  afp_temp = datos2 %>%
    filter(A.F.P. == afps[i])
  print(paste(afps[i], nrow(afp_temp)))
}
```

```{r}
new_afps = subset(datos2, !(A.F.P. %in% c("UNO", "BANSANDER", "SANTA MARIA")))
afps_new = unique(new_afps$A.F.P.)
afps_new
```

```{r}
paste("AFP", "A", "B", "C", "D", "E")
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
    filter(A.F.P. == afps_new[i])
  print(paste(afps_new[i], mean(afp_temp$A), mean(afp_temp$B), mean(afp_temp$C), mean(afp_temp$D), mean(afp_temp$E)))
}
```

```{r}
new_afps$Mes = plyr::revalue(new_afps$Mes, c("Enero" = 1, "Febrero" = 2, "Marzo" = 3, "Abril" = 4, "Mayo" = 5, "Junio" = 6, "Julio" = 7, "Agosto" = 8, "Septiembre" = 9, "Octubre" = 10, "Noviembre" = 11, "Diciembre" = 12))
new_afps$Mes = as.numeric(new_afps$Mes)
new_afps$Año = as.numeric(new_afps$Año)

new_afps$t = new_afps$Año + (new_afps$Mes - 1)/12
new_afps_melt = melt(new_afps, id = c("A.F.P.", "Año", "Mes", "t"))
capital_long = filter(new_afps_melt, A.F.P. == "CAPITAL")
capital_wide = filter(new_afps, A.F.P. == "CAPITAL")
```

```{r}
ggplot(capital_long, aes(x = t, y = value)) +
  geom_line(aes(color = variable, linetype = variable)) +
  labs(title = fn(""))
```

```{r, echo = FALSE}
a = ggplot(capital_wide, aes(x = t)) + geom_line(aes(y = A)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(paste("SD=", sd(capital_wide$A))), y = "Fondo A")
b = ggplot(capital_wide, aes(x = t)) + geom_line(aes(y = B)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(paste("SD=", sd(capital_wide$B))), y = "Fondo B")
c = ggplot(capital_wide, aes(x = t)) + geom_line(aes(y = C)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(paste("SD=", sd(capital_wide$C))), y = "Fondo C")
d = ggplot(capital_wide, aes(x = t)) + geom_line(aes(y = D)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(paste("SD=", sd(capital_wide$D))), y = "Fondo D")
e = ggplot(capital_wide, aes(x = t)) + geom_line(aes(y = E)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(paste("SD=", sd(capital_wide$E))), y = "Fondo E")
arr = ggarrange(a, b, c, d, e)
```




```{r}
auto.arima(abs(capital_wide$A))
```

```{r}
acf(abs(capital_wide$A))
```

```{r}
ggplot(capital_wide, aes(x = log(abs(A)))) +
  geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
  geom_density() +
  labs(x = "Rentabilidad", y = "Densidad")
```

```{r}
kurtosis(capital_wide$A)
skewness(capital_wide$A)
```

```{r}
meses_positivos = data.frame(matrix(ncol = 7, nrow = 7))
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
    filter(A.F.P. == afps_new[i])
  meses_positivos[i, ] = c(afps_new[i], sum(afp_temp$A > 0), sum(afp_temp$B > 0), sum(afp_temp$C > 0),  sum(afp_temp$D), sum(afp_temp$E > 0), nrow(afp_temp))
}

colnames(meses_positivos) = c("AFP", "A", "B", "C", "D", "E", "Meses_Totales")
meses_positivos
```

```{r}
meses_perc = meses_positivos %>%
  mutate(A_Perc = as.numeric(A)/as.numeric(Meses_Totales),
         B_Perc = as.numeric(B)/as.numeric(Meses_Totales),
         C_Perc = as.numeric(C)/as.numeric(Meses_Totales),
         D_Perc = as.numeric(D)/as.numeric(Meses_Totales),
         E_Perc = as.numeric(E)/as.numeric(Meses_Totales))
```

```{r}
meses_perc[, c(1, 8:12)]
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2007) %>%
  filter(t <= 2010)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = A)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]))
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp)
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2019) %>%
  filter(t <= 2021)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = A)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]), y = "")
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp) 
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2020)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = A)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]), y = "")
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp) 
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2007) %>%
  filter(t <= 2010)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = E)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]), y = "")
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp) 
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2019) %>%
  filter(t <= 2021)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = E)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]))
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp) 
```

```{r, fig.height=8, fig.width=13}
arr_temp = list()
for (i in 1:length(afps_new)){
  afp_temp = new_afps %>%
  filter(A.F.P. == afps_new[i]) %>%
  filter(t >= 2020)
  plot_temp = ggplot(afp_temp, aes(x = t)) + geom_line(aes(y = E)) + geom_hline(yintercept = 0, colour = "red") +
  labs(title = fn(afps_new[i]), y = "")
  arr_temp[[i]] = plot_temp
}
do.call(grid.arrange, arr_temp) 
```


# **Resultados**

# **Conclusión**

Luego de haber analizado los gráficos, podemos concluir que en su mayoría, las crisis internacionales afectan muy negativamente al fondo A, mientras que los sucesos que ocurren en nuestro país, no generan mucho efecto en sus rentabilidades, lo que es contrario al fondo E, que es muy reactivo a las tragedias nacionales, además podemos observar la gran diferencia de ganancias que hay entre ambos fondos, ya que a pesar de tener pérdidas exageradas, el fondo A siempre logra recuperarse, y los años que han resultado terribles para este, sin incluir la crisis financiera, simplemente lo han dejado sin ganancias, o con unas pérdidas que no superan al 5%, esto nos da información importante para decidir el nivel de riesgo a elegir en un fondo, ya que mientras superior sea el lapso de tiempo, mayor es la diferencia de rentabilidades que hay, y que a pesar de que las cosas no estén bien en el país, podemos seguir aumentando nuestro patrimonio.

Sobre los AFPs en particular, no es muy relevante cual, ya que las comisiones no son tan altas, y en fondos similares, la mayoría reportan cantidades de meses positivos similares, y ganancias relativamente parecidas, así que no son tan relevantes para nuestro caso.

Dando un último vistazo a los gráficos, ya que analizamos la correlación entre los dos fondos, esto se puede observar en la diferencia de variabilidad de los dos datos, ya que son gráficos parecidos, donde el fondo A tiene movimientos mucho más bruscos, y erráticos, mientras que el fondo E representa una versión mucho más pareja de la curva, con menos fluctuaciones.

# **Anexo**

[1] [Fondo de Pensiones](https://afiliadoinformado.cl/wp-content/uploads/2018/06/12_FondodePensiones.pdf) 

[2] [Rentabilidades](https://www.spensiones.cl/apps/rentabilidad/getRentabilidad.php?tiprent=FP&template=0) 

[3] [Web-Scraping](https://github.com/DiegoGR2021/proyecto_let0010_1/blob/main/codigo/web_scraperdef.py)